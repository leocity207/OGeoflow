digraph  {
	graph [compound=true   newrank=true]
	rankdir="LR"
	splines=ortho

	subgraph {
		rank=same
		INT [shape=circle label="Int()"]
		SWITCH_STATE_INT [shape=box label="switch(Current_State())"]
		
		PROPERTIES_SUB_KEY [shape=diamond]
		PROPERTIES_SUB_ARRAY [shape=diamond]
        ID [shape=diamond]

		INT -> SWITCH_STATE_INT ->PROPERTIES_SUB_KEY;
		PROPERTIES_SUB_KEY -> PROPERTIES_SUB_ARRAY -> ID -> DOUBLE [arrowtail=dot dir=both]
	}

    subgraph {
		rank=same
		DOUBLE [shape=circle label="Double()"]
		SWITCH_STATE_DOUBLE [shape=box label="switch(Current_State())"]
		
		PROPERTIES_SUB_KEY_DOUBLE [shape=diamond label="PROPERTIES_SUB_KEY" ]
		PROPERTIES_SUB_ARRAY_DOUBLE [shape=diamond label="PROPERTIES_SUB_ARRAY"]
        ID_DOUBLE [shape=diamond label="ID"]
        COORDINATES [shape=diamond]
        BBOX [shape=diamond]
        FOREIGN_ARRAY [shape=diamond]
        FOREIGN_KEY [shape=diamond]

		DOUBLE -> SWITCH_STATE_DOUBLE ->PROPERTIES_SUB_KEY_DOUBLE;
		PROPERTIES_SUB_KEY_DOUBLE -> PROPERTIES_SUB_ARRAY_DOUBLE -> ID_DOUBLE -> COORDINATES -> BBOX ->  FOREIGN_ARRAY -> FOREIGN_KEY -> FALSE[arrowtail=dot dir=both]
	}

    


    subgraph {
        IN_ARRAY [shape=diamond label="In_Array()"]
    }

    subgraph {
        POP_CONTEXT [shape=box label="Pop_Context()"]
    }

    IN_ARRAY -> POP_CONTEXT
    IN_ARRAY -> TRUE [arrowtail=dot dir=both]


    subgraph PORPERTY_SUBKEY_GRAPH{
        subgraph {
            rank=same;
            CHECK_SUBKEY_IS_OBJECT [shape=diamond label="current_property.Is_Object()"]
            CHECK_SUBKEY_KEY_DUPLICATION [shape=diamond label="current_property.contains(\"current_key\")"]
        }

        subgraph {
            rank=same
            FALSE_UNEXPECTED_PROPERTY_STATE [shape=circle label="False"]
            FALSE_UNEXPECTED_PROPERTY_STATE_NOTE [shape=none, label="UNEXPECTED_PROPERTY_STATE"];
            FALSE_UNEXPECTED_PROPERTY_STATE -> FALSE_UNEXPECTED_PROPERTY_STATE_NOTE [style=invis]
        }

        subgraph {
            rank=same
            FALSE_PROPERTY_KEY_ALREADY_EXIST [shape=circle label="False"]
            FALSE_PROPERTY_KEY_ALREADY_EXIST_NOTE [shape=none, label="PROPERTY_KEY_ALREADY_EXIST"];
            FALSE_PROPERTY_KEY_ALREADY_EXIST -> FALSE_PROPERTY_KEY_ALREADY_EXIST_NOTE [style=invis]
        }

        CHECK_SUBKEY_IS_OBJECT -> FALSE_UNEXPECTED_PROPERTY_STATE [arrowtail=dot dir=both]
        CHECK_SUBKEY_KEY_DUPLICATION -> FALSE_PROPERTY_KEY_ALREADY_EXIST [arrowtail=dot dir=both]
        CHECK_SUBKEY_IS_OBJECT -> CHECK_SUBKEY_KEY_DUPLICATION
        {PROPERTIES_SUB_KEY PROPERTIES_SUB_KEY_DOUBLE} ->  CHECK_SUBKEY_IS_OBJECT
        CHECK_SUBKEY_KEY_DUPLICATION -> IN_ARRAY
    }

    subgraph PROPERTIES_SUB_ARRAY_GRAPH{
        subgraph {
            rank=same;
            CHECK_SUBARRAY_IS_ARRAY [shape=diamond label="current_property.Is_Array()"]
        }

        subgraph {
            rank=same
            FALSE_UNEXPECTED_PROPERTY_STATE2 [shape=circle label="False"]
            FALSE_UNEXPECTED_PROPERTY_STATE_NOTE2 [shape=none, label="UNEXPECTED_PROPERTY_STATE"];
            FALSE_UNEXPECTED_PROPERTY_STATE2 -> FALSE_UNEXPECTED_PROPERTY_STATE_NOTE [style=invis]
        }

        CHECK_SUBARRAY_IS_ARRAY -> FALSE_UNEXPECTED_PROPERTY_STATE2 [arrowtail=dot dir=both]
        {PROPERTIES_SUB_ARRAY PROPERTIES_SUB_ARRAY_DOUBLE} ->  CHECK_SUBARRAY_IS_ARRAY
        CHECK_SUBARRAY_IS_ARRAY -> IN_ARRAY
    }

    REGISTER_ID [shape=box label="id = std::to_string(value)"]
    CHECK_LEVEL [shape=diamond label="m_level != m_max_level"]
    EMPLACE_POSITION [shape=box label="position.push(value)"]
    
    subgraph {
            rank=same
        FALSE_LEVEL_MISMATCH [shape=circle label="False"]
        FALSE_LEVEL_MISMATCH_NOTE [shape=none, label="LEVEL_MISMATCH"];
        FALSE_LEVEL_MISMATCH -> FALSE_LEVEL_MISMATCH_NOTE [style=invis]
    }

    CHECK_LEVEL -> FALSE_LEVEL_MISMATCH [arrowtail=dot dir=both]

    ID -> REGISTER_ID -> IN_ARRAY
    ID_DOUBLE -> REGISTER_ID
    {COORDINATES BBOX} -> CHECK_LEVEL
    CHECK_LEVEL -> EMPLACE_POSITION -> IN_ARRAY
    {FOREIGN_ARRAY FOREIGN_KEY} -> IN_ARRAY

    {CHECK_SUBKEY_IS_OBJECT -> CHECK_SUBKEY_KEY_DUPLICATION -> CHECK_SUBARRAY_IS_ARRAY [style=invis] rank=same }


	TRUE  [shape=circle label="True"]
	subgraph {
		FALSE [shape=circle label="False"]
		FALSE_NOTE [shape=none, label="UNEXPECTED_STATE_OBJECT"];
		FALSE -> FALSE_NOTE [style=invis]
		rank=same
	}

}